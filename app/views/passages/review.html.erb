<% page_title I18n.t :memory_verse_review, :scope => 'page_titles' %>

<div class="white-box-bg">
<div class="main-verse-review">

    <div class="passage-entry">

        <div class="passage-id"></div>

        <h2  class="passage-title"></h2>

        <div class="passage-text">

        </div>


    </div> <!-- end: passage-entry column -->

    <div class="upcoming-passages upcoming">
        <h2>Upcoming Passages</h2>
    </div> <!-- end: upcoming-passage column -->

</div>
</div>

<script language="JavaScript" type="text/javascript"><!--

    $(document).ready(function() {

        //-------  This can be moved to memverse_lib once development is done
        var reviewState = {
            // setup
            initialize: function () {
                // Retrieve passages that are due for review
                $.getJSON('passages/due.json', function (data) {

                    var items = [];

                    // Build list
                    $.each(data, function( index, mv ) {
                        items.push('<li class="upcoming-verse-ref white2" id="' + mv.id + '">' + mv.ref + '</li>');
                    });

                    // Add entire list
                    $('<ul/>', { 'class': 'passage-list', html: items.join('') }).appendTo('.upcoming-passages');

                    // Load first passage
                    reviewState.autoAdvancePassage();

                });

            },

            selectPassage: function ( passageRef, passageID ) {
                // retrieve memory verses for passage
                $.getJSON('passages/' + passageID + '/memverses.json', function (data) {
                    // display passage
                    mvDisplayPassageForReview( passageRef, passageID, data )
                });
            },

            clearCurrentPassage: function () {
                // check whether user has completed the review of the passage
                var passageNotReviewed = $(".due-mv").length;
                var passageID          = $(".passage-id").html();

                if (passageID) {
                    if (passageNotReviewed) {
                        $('.passage-list #' + passageID).fadeIn(); // show passage again
                    } else {
                        $('.passage-list #' + passageID).remove(); // remove from upcoming passages
                    }
                }

                $(".passage-text").empty();
                $(".passage-title").empty();
            },

            autoAdvancePassage: function ( ) {

                var $nextPassage  = [];

                reviewState.clearCurrentPassage();  // Clear current passage

                // Select next passage from top of list
                $nextPassage = $( ".upcoming-passages" ).find(".upcoming-verse-ref").first();

                if ($nextPassage.length) {
                    $nextPassage.fadeOut('slow');
                    reviewState.selectPassage( $nextPassage.text(), $nextPassage.attr('id') );
                } else {
                    alert("No more passages to review.");
                }
            },

            gotoNextVerseDue: function ( $currentVerse ) {

                var $nextDue      = $currentVerse.nextAll(".due-mv").first();
                var $firstSkipped

                // If there are more verses due in the passage
                if ($nextDue.length) {
                    // Scroll to next verse
                    $('html').scrollTo($nextDue, { easing: 'easeInOutCubic', duration: 1500, offset: -250 } );
                    // advance cursor to first word of next verse
                    $nextDue.find('.blank-word').first().focus();

                // Check for earlier verses in passage that were skipped
                } else if ( $currentVerse.siblings(".due-mv").length ) {
                    // find first skipped verse
                    $firstSkipped = $currentVerse.siblings(".due-mv").first();
                    // Scroll to prior verse
                    $('html').scrollTo($firstSkipped, { easing: 'easeInOutCubic', duration: 1500, offset: -250 } );
                    // advance cursor to first word of next verse
                    $nextDue.find('.blank-word').first().focus();

                // Get next passage if no more verses on this one
                } else {

                    reviewState.autoAdvancePassage();

                }
            }
        }

        //------- Initialize session ------------------
        reviewState.initialize();

        //------- Select passage for review -----------
        $( ".upcoming-passages" ).on( "click", ".upcoming-verse-ref", function( e ) {
            $(this).fadeOut();
            reviewState.clearCurrentPassage();    // clear current passage
            reviewState.selectPassage( $(this).text(), $(this).attr('id') );
        });

        //------- Typing a verse ----------------------
        $(".passage-text").on( "keyup", "input.blank-word", function (e) {

            var correctWord = this.name;
            var userGuess   = this.value.trim();

            // Word correct ==> next word
            if ( scrub_text( correctWord ) === scrub_text( userGuess ) ) {
                $(this).next().focus();  // advance cursor to next blank word
                $(this).replaceWith( correctWord );
            }

            // check for down arrow keypress
            else if ( e.keyCode === 40 ) {
                // show current word
                $(this).val( correctWord ).animate({ color: '#FFD' }, 1100, 'easeInExpo', function() {
                    $(this).val('');
                    $(this).css({color:'#444'}); // same color as .assistance
                });;
            }

        });

        //------- Scoring a verse ----------------------
        $( ".passage-text" ).on( "click", ".score-test-buttons .submit", function( e ) {

            var $currentVerse = $(this).closest(".single-verse-in-passage");

            var q             = $(this).attr("q");
            var id            = $(this).parent().prev(".mv-id").html();

            // Remove verse-due flag
            $(this).closest(".single-verse-in-passage").removeClass("due-mv");
            // Fade out rating buttons
            $(this).closest(".passage-rating").fadeOut();

            // Submit rating
            $.getJSON("/mark_test_quick", { mv: id, q: q  }, function(data) {
                if (data.msg) {  setTimeout(function() {alert(data.msg);}, 1); }  // Give user a non-blocking response
            });

            // Scroll to next verse that is due for review
            reviewState.gotoNextVerseDue( $currentVerse );

        });

    }); // End of jQuery document ready
--></script>