<% page_title I18n.t :memory_verse_review, :scope => 'page_titles' %>

<div class="white-box-bg">

    <div class="verse-selection">

        <!-- Reference entry box -->
        <div class="verse-field ui-widget">
            <label class="tag">Enter a reference or tag</label>
            <img class="spinner spinner-add-verse" id="ajax_spinner" src="/assets/indicator2.gif" alt="Searching ..." style="display: none" />
            <%= text_field_tag(:verse, params[:verse], :class => "flex-verse-search", :id => "js_flex-verse-search", :placeholder => "e.g. Romans 3:2-5 or 'creation'" )%> 
        </div>        

        <!-- Search Results -->
        <div class="mv-search-results-compact">
            <%= render "verses/scroll" %>
        </div>


        <!-- Action buttons -->
        <div class="verse-list-actions">

        </div>

    </div> 

    <!-- Center Panel -->
    <div class="verse-learning">
        

        <div class="top-heading">
            <h2><span><%= t('.verse') %>: </span><span class="verse-ref"><%=@mv.verse.ref%></span><span class="verse-tl"> [<%=@mv.verse.translation %>]</span></h2>
            <div id="toggle-hint" class="toggle-hint"><%= t('.show_verse') %></div>
        </div>

        <div class="assistance">

            <div class="mtext     "><%= @mv.mnemonic_if_req %></div><div class="mclose">x</div>
            <div class="blankified"></div>

        </div>

        <div class="verse-entry">
            <textarea class="verse-practice-box"></textarea>
        </div>

        <div class="progression-control">
            <div class="dec-level"><%= image_tag( "left_arrow.png",  :width => 48, :height => 48 ) %></div>
            <div class="cur-level">Level <span class="level-num">4</span></div>        
            <div class="inc-level"><%= image_tag( "right_arrow.png", :width => 48, :height => 48 ) %></div>
        </div>

    </div>

    <!-- Right Panel -->
    <div class="right-panel">
        <div class="verse-ref-list">
            <h3>Practice List</h3>
            <ul id="upcoming-verses">
            </ul>   
        </div>  
    </div>

</div>

<script language="JavaScript" type="text/javascript"><!--
    
    $(document).ready(function() {

        //------- State variables ---------------------
        var practiceState = {
            
            // verse being learned
            ref:      null,
            fullText: null,
            mnemonic: null,
            mvId:     null,

            // verses in practice queue
            queued_verses: 0,

            // in memory queue
            queue: [],

            // current level
            level: 1,

            // add verse to the in-memory queue
            addToQueue: function ( $Verse ) {
                
                var queueVerse = {
                    mvId        : $Verse.find(".mv-id").html(),
                    ref         : $Verse.find(".ref").html(),
                    fullText    : $Verse.find(".full-text").html(),
                    mnemonic    : $Verse.find(".mnemonic").html()
                }
                
                this.queue.push( queueVerse );

                console.log( "Verses in queue: " + this.queued_verses )
                console.log( this.queue );

                if (this.queued_verses == 0) {
                    this.nextVerse( )
                }

                this.queued_verses += 1;

            },

            // remove verse from the in-memory queue
            removeFromQueue: function () {

            },


            // update status of current verse
            startReview: function () {

            },
            
            // get next verse
            nextVerse: function () {

                var replacementVerse = this.queue.shift();    // remove first verse from queue
                this.queued_verses -= 1;                      // update queue count

                this.level    = 1;      
                this.fullText = replacementVerse.fullText;
                this.ref      = replacementVerse.ref;
                this.mnemonic = replacementVerse.mnemonic;
                this.mvId     = replacementVerse.mvId;

                $(".verse-ref ").html( replacementVerse.ref );
                $(".level-num ").html( "1" );
                $(".mtext     ").html( replacementVerse.mnemonic );
                $(".blankified").html( blankifyVerse( replacementVerse.fullText, this.level * 10 ) );

            },

            // move verse to next level of difficulty
            levelUp: function () {
                
                this.level += 1;

                $(".level-num ").html( this.level );
                $(".blankified").html( blankifyVerse( this.fullText, this.level * 10 ) );

            },

            // move verse to previous level of difficulty
            levelDown: function () {

                this.level -= 1;

                $(".level-num ").html( this.level );
                $(".blankified").html( blankifyVerse( this.fullText, this.level * 10 ) );
                
            }

        };


        //------- Initial setup -----------------------
        // initialize scrollable module
        $(".scrollable").scrollable({ vertical: true, mousewheel: true });

        //------- Searching for a verse----------------
        $("#js_flex-verse-search").observe_field(0.2, function( ) { 
            // clear prior search results
            clearSearchResults();
            // search and display results with callback function
            mv_search(this.value, displayMvSearchResultsFn );
        });

        //------- Selecting verses to practice -------
        $( ".mv-search-results-compact" ).on( "click", ".select-verse-button", function( e ) {

            var $verseToAdd    = $(this).siblings(".ref-and-details");
            var $verseForQueue = $verseToAdd.clone()

            // Add verse to memory queue
            practiceState.addToQueue( $verseForQueue );

            // Hide first words
            $verseForQueue.find(".first-words").hide();

            // Build HTML for each verse
            var $queued_vs = $('<li/>').addClass('upcoming-verse-ref')
                // verse
                .append( $verseForQueue )
                // remove button
                .append('<div class="remove-verse-button"><a data-remote="true" href="/add/' + '" class="compact-remove-button"></a></div>');

            // Move verse from search results to verse queue
            $("#upcoming-verses").append( $queued_vs );

            $verseToAdd.parent().fadeOut("fast");
        }); 

        //------- Typing a verse ----------------------

        //------- Changing a level --------------------
        $( ".progression-control" ).on( "click", ".inc-level", function( e ) {
            practiceState.levelUp();
        });

        $( ".progression-control" ).on( "click", ".dec-level", function( e ) {
            practiceState.levelDown();
        });

    }); // End of jQuery document ready

--></script>        