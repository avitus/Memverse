<% page_title I18n.t :add_new_verses, :scope => 'page_titles' %>
<% page_description I18n.t :add_new_verses, :scope => 'page_descriptions' %>
<div class="white-box-bg">
	
	<!-- SEARCH ENTRY: LEFT COLUMN -->
	<div id="add-verse-enter-ref">
		
		<div class="top-heading">
	    	<h3><span>Add a New Memory Verse</span></h3>
	    </div>

		<%= content_tag "div", id: "translation", data: {tl: @translation } do %>
		<!-- Get translation -->
		<% end %>

		<!-- Reference entry box -->
		<div class="verse-field ui-widget">
			<label class="tag">Enter a reference or keyword</label>
			<img class="spinner spinner-add-verse" id="ajax_spinner" src="/assets/indicator2.gif" alt="Searching ..." style="display: none" />
			<%= text_field_tag(:verse, params[:verse], :class => "flex-verse-search", :id => "js_flex-verse-search" )%> 
		</div>

		<!-- Add entire chapter -->
		<div class="add-chapter">
			<%= link_to 'Add Chapter', '#', :class => "add-chapter-button", :id => "add-chapter" %>						
		</div>

	</div>	  

	<!-- SEARCH RESULTS: RIGHT COLUMN -->
	<div id="verse-search-results">
		
		<!-- Results of single verse retrieval -->    
	    <div id="verse-search-single-result">
		    
		    <!-- Display existing verse -->
			<div id="existing-verse-add" class="quick-start-show-verse quick-start-add-section">
			    <div id="foundVerse"></div>  							    <!-- Text of retrieved verse-->
			    <div id="add-verse-button" class="add-verse-button"></div>	<!-- Button to add verse -->
			</div>
		    
		    <!-- Display box to enter a new verse -->
			<div id="new-verse-entry" class="create-and-add">
		    	<label class="tag">Enter Verse Text:</label>
				<%= text_area_tag(:versetext, params[:versetext], :overflow => "hidden", :class => "verse-entry-box" )%>
			    <div class="add-verse-button">
			   		<div class="quick-start-add-button"></div>
			   	</div>
		    </div>
		    
	    </div>
		
		<!-- Results of passage or multiple verse retrieval -->    		
		<div class="verse-search-results-scroll quick-start-add-section">
			<%= render "verses/scroll" %>
		</div>			
			
	</div>
	
	<div class="clr"></div><!-- Clear floats -->
</div> <!-- white-box-bg -->

<script language="JavaScript" type="text/javascript"><!--
	$(document).ready(function() {
	
		// Get user's translation
		tl = $('#translation').data('tl'); // Get the users translation
	
		// initialize scrollable module
		$(".scrollable").scrollable({ vertical: true, mousewheel: true });
		
		// define flexversesearch function
		function flexversesearch(text){
			// User is looking for a single verse						
			if (ref = parseVerseRef($.trim(text))) {
				$.get("/lookup_verse.json", { bk: ref.bk, ch: ref.ch, vs: ref.vs, tl: tl },
					function(verse) {	
	
						// Clear search results
						clearSearchResults();
						$(".verse-search-results-scroll").hide();
						$("#verse-search-single-result").show();
								
						if (typeof(verse) !== 'undefined' && verse != null) {
							$("#new-verse-entry").hide();												
							$("#foundVerse").append($('<h4/>').text(verse.ref)).append($('<p/>').text(verse.text));
							$("#add-verse-button").html("<a data-remote='true' href='/add/" + verse.id + "'class='quick-start-add-button' id='quick-start-add'></a>");
						} else {					
							$("#new-verse-entry").slideDown();																
							$("#add-verse-button").empty();
							$("#new-verse-entry .add-verse-button").html("<div class='quick-start-add-button'></div>")  // show add button
						};
	
				}, "json" );	
						
			// User is searching for a passage
			} else if (ref = parsePassageRef($.trim(text))) {
				$.get("/lookup_passage.json", { bk: ref.bk, ch: ref.ch, vs_start: ref.vs_start, vs_end: ref.vs_end, tl: tl },
					function(verses) {
						
						// TODO: Potentially insert missing verses with option to create a new verse					
						clearSearchResults();         // clear existing search results
						displaySearchResults(verses); // display new search results
						checkChapter(ref, tl);
						
				}, "json" );
			
			// User didn't enter a verse reference ... do a keyword search
			} else {
				$.get("/search_verse.json", { searchParams: $.trim(text + " " + tl)  },
					function(verses) {
					
						clearSearchResults();         // clear existing search results
						displaySearchResults(verses); // display new search results			
					
				}, "json" );
			}
		} // end flexversesearch function
		
		// Setup jEditable for version changing
		$('#js_bible-version').editable(function(value, settings) { 
			tl = value; // change tl
			flexversesearch($("#js_flex-verse-search").val()); // refresh results
			return(settings.data[value]);
			// TODO: Can't figure out why after changing the version and clicking on the select again, it still defaults to the original 'selected' value
		}, { 
			data   : <%= TRANSLATIONS.to_json.html_safe %>,
			type   : 'select',
			submit : 'OK'
		});
	
		// Verse entry and retrieval
		$("#js_flex-verse-search").observe_field(0.2, function( ) { 
			flexversesearch(this.value);
		});
		
		// User adds a new verse
		$('.create-and-add').on("click", ".quick-start-add-button", function() {      // Bind to DIV enclosing button to allow for event delegation
			$button   = $('.create-and-add .quick-start-add-button');
			ref       = parseVerseRef( $("#verse").val().trim());
			newVerse  = cleanseVerseText( $("#versetext").val() );		
						
			if ( ref ) { 
				createVerseAndAdd(ref, tl, newVerse, $button);
			} else {
				alert("The Bible reference you have entered is not valid.")
			};	
		});	
	
		// User adds entire passage	
		$('.add-chapter').on("click", ".add-chapter-button", function() {		
			ref = parsePassageRef( $("#verse").val().trim() );
			$.post("/add_chapter.json", { bk: ref.bk, ch: ref.ch, tl: tl }, function(response) { 
				$(".add-chapter-button").replaceWith("<div class='verse-added'></div>");
			});
		});
		
	});
--></script>
