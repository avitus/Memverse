// Call `BIBLEBOOKS.to_json` to obtain...
BIBLEBOOKS = "{\"en\":{\"Gen\":\"Genesis\",\"Ex\":\"Exodus\",\"Lev\":\"Leviticus\",\"Num\":\"Numbers\",\"Deut\":\"Deuteronomy\",\"Josh\":\"Joshua\",\"Judg\":\"Judges\",\"Ruth\":\"Ruth\",\"1 Sam\":\"1 Samuel\",\"2 Sam\":\"2 Samuel\",\"1 Kings\":\"1 Kings\",\"2 Kings\":\"2 Kings\",\"1 Chron\":\"1 Chronicles\",\"2 Chron\":\"2 Chronicles\",\"Ezra\":\"Ezra\",\"Neh\":\"Nehemiah\",\"Es\":\"Esther\",\"Job\":\"Job\",\"Ps\":\"Psalms\",\"Prov\":\"Proverbs\",\"Eccl\":\"Ecclesiastes\",\"Song\":\"Song of Songs\",\"Isa\":\"Isaiah\",\"Jer\":\"Jeremiah\",\"Lam\":\"Lamentations\",\"Ezk\":\"Ezekiel\",\"Dan\":\"Daniel\",\"Hos\":\"Hosea\",\"Joel\":\"Joel\",\"Amos\":\"Amos\",\"Obad\":\"Obadiah\",\"Jonah\":\"Jonah\",\"Mic\":\"Micah\",\"Nahum\":\"Nahum\",\"Hab\":\"Habakkuk\",\"Zeph\":\"Zephaniah\",\"Hag\":\"Haggai\",\"Zech\":\"Zechariah\",\"Mal\":\"Malachi\",\"Matt\":\"Matthew\",\"Mark\":\"Mark\",\"Luke\":\"Luke\",\"Jn\":\"John\",\"Acts\":\"Acts\",\"Rom\":\"Romans\",\"1 Cor\":\"1 Corinthians\",\"2 Cor\":\"2 Corinthians\",\"Gal\":\"Galatians\",\"Eph\":\"Ephesians\",\"Phil\":\"Philippians\",\"Col\":\"Colossians\",\"1 Thess\":\"1 Thessalonians\",\"2 Thess\":\"2 Thessalonians\",\"1 Tim\":\"1 Timothy\",\"2 Tim\":\"2 Timothy\",\"Tit\":\"Titus\",\"Phlm\":\"Philemon\",\"Heb\":\"Hebrews\",\"James\":\"James\",\"1 Pet\":\"1 Peter\",\"2 Pet\":\"2 Peter\",\"1 John\":\"1 John\",\"2 John\":\"2 John\",\"3 John\":\"3 John\",\"Jude\":\"Jude\",\"Rev\":\"Revelation\"},\"es\":{\"Gén\":\"Génesis\",\"Éxod\":\"Éxodo\",\"Lev\":\"Levitico\",\"Núm\":\"Números\",\"Deut\":\"Deuteronomio\",\"Jos\":\"Josué\",\"Jue\":\"Jueces\",\"Rut\":\"Rut\",\"1 Sam\":\"1 Samuel\",\"2 Sam\":\"2 Samuel\",\"1 Re\":\"1 Reyes\",\"2 Re\":\"2 Reyes\",\"1 Cró\":\"1 Crónicas\",\"2 Cró\":\"2 Crónicas\",\"Esd\":\"Esdras\",\"Neh\":\"Nehemías\",\"Est\":\"Ester\",\"Job\":\"Job\",\"Sal\":\"Salmos\",\"Prov\":\"Proverbios\",\"Ecl\":\"Eclesiastés\",\"Cant\":\"Cantares\",\"Is\":\"Isaías\",\"Jer\":\"Jeremías\",\"Lam\":\"Lamentaciones\",\"Ez\":\"Ezequiel\",\"Dan\":\"Daniel\",\"Os\":\"Oseas\",\"Jl\":\"Joel\",\"Am\":\"Amós\",\"Abd\":\"Abdías\",\"Jon\":\"Jonás\",\"Miq\":\"Miqueas\",\"Nah\":\"Nahún\",\"Hab\":\"Habacuc\",\"Sof\":\"Sofonías\",\"Ag\":\"Hageo\",\"Zac\":\"Zacarías\",\"Mal\":\"Malaquías\",\"Mt\":\"Mateo\",\"Mc\":\"Marcos\",\"Lc\":\"Lucas\",\"Jn\":\"Juan\",\"Hech\":\"Hechos\",\"Rom\":\"Romanos\",\"1 Cor\":\"1 Corintios\",\"2 Cor\":\"2 Corintios\",\"Gál\":\"Gálatas\",\"Ef\":\"Efesios\",\"Fil\":\"Filipenses\",\"Col\":\"Colosenses\",\"1 Tes\":\"1 Tesalonicenses\",\"2 Tes\":\"2 Tesalonicenses\",\"1 Tim\":\"1 Timoteo\",\"2 Tim\":\"2 Timoteo\",\"Tit\":\"Tito\",\"Filem\":\"Filemón\",\"Heb\":\"Hebreos\",\"Sant\":\"Santiago\",\"1 Pe\":\"1 Pedro\",\"2 Pe\":\"2 Pedro\",\"1 Jn\":\"1 Juan\",\"2 Jn\":\"2 Juan\",\"3 Jn\":\"3 Juan\",\"Jds\":\"Judas\",\"Apoc\":\"Apocalipsis\"},\"et\":{\"1Ms\":\"1. Moosese raamat\",\"2Ms\":\"2. Moosese raamat\",\"3Ms\":\"3. Moosese raamat\",\"4Ms\":\"4. Moosese raamat\",\"5Ms\":\"5. Moosese raamat\",\"Jos\":\"Joosua\",\"Km\":\"Kohtumõistjate raamat\",\"Rt\":\"Rutt\",\"1Sm\":\"1. Saamueli raamat\",\"2Sm\":\"2. Saamueli raamat\",\"1Kn\":\"1. Kuningate raamat\",\"2Kn\":\"2. Kuningate raamat\",\"1Aj\":\"1. Ajaraamat\",\"2Aj\":\"2. Ajaraamat\",\"Esr\":\"Esra\",\"Ne\":\"Nehemja\",\"Est\":\"Ester\",\"Ii\":\"Iiob\",\"Ps\":\"Psalmid (Laulud)\",\"p\":\"Õpetussõnad \",\"Kg\":\"Koguja\",\"l\":\"Ülemlaul \",\"Js\":\"Jesaja\",\"Jr\":\"Jeremija\",\"Nl\":\"Nutulaulud\",\"Hs\":\"Hesekiel\",\"Tn\":\"Taaniel\",\"Ho\":\"Hoosea\",\"Jl\":\"Joel\",\"Am\":\"Aamos\",\"Ob\":\"Obadja\",\"Jn\":\"Joona\",\"Mi\":\"Miika\",\"Na\":\"Nahum\",\"Ha\":\"Habakuk\",\"Sf\":\"Sefanja\",\"Hg\":\"Haggai\",\"Sk\":\"Sakarja\",\"Ml\":\"Malaki\",\"Mt\":\"Matteuse evangeelium\",\"Mk\":\"Markuse evangeelium\",\"Lk\":\"Luuka evangeelium\",\"Jh\":\"Johannese evangeelium\",\"Ap\":\"Apostlite teod\",\"Rm\":\"Pauluse kiri Roomlastele\",\"1Kr\":\"Pauluse 1. kiri korintlastele\",\"2Kr\":\"Pauluse 2. kiri korintlastele\",\"Gl\":\"Pauluse kiri galaatlastele\",\"Ef\":\"Pauluse kiri efestlastele\",\"Fl\":\"Pauluse kiri filiplastele\",\"Kl\":\"Pauluse kiri koloslastele\",\"1Ts\":\"Pauluse 1. kiri tessalooniklastele\",\"2Ts\":\"Pauluse 2. kiri tessalooniklastele\",\"1Tm\":\"Pauluse 1. kiri Timoteosele\",\"2Tm\":\"Pauluse 2. kiri Timoteosele\",\"Tt\":\"Pauluse kiri Tiitusele\",\"Fm\":\"Pauluse kiri Fileemonile\",\"Hb\":\"Kiri heebrealastele\",\"Jk\":\"Jaakobuse kiri\",\"1Pt\":\"Peetruse 1. kiri\",\"2Pt\":\"Peetruse 2. kiri\",\"1Jh\":\"Johannese 1. kiri\",\"2Jh\":\"Johannese 2. kiri\",\"3Jh\":\"Johannese 3. kiri\",\"Jd\":\"Juuda kiri\",\"Ilm\":\"Johannese ilmutus\"},\"ko\":{\"창\":\"창세기\",\"출\":\"출애굽기\",\"레\":\"레위기\",\"민\":\"민수기\",\"신\":\"신명기\",\"수\":\"여호수아\",\"삿\":\"사사기\",\"룻\":\"룻기\",\"삼상\":\"사무엘상\",\"삼하\":\"사무엘하\",\"왕상\":\"열왕기상\",\"왕하\":\"열왕기하\",\"대상\":\"역대상\",\"대하\":\"역대하\",\"스\":\"에스라\",\"느\":\"느헤미야\",\"에\":\"에스더\",\"욥\":\"욥기\",\"시\":\"시편\",\"잠\":\"잠언\",\"전\":\"전도서\",\"아\":\"아가\",\"사\":\"이사야\",\"렘\":\"예레미야\",\"애\":\"예레미야애가\",\"겔\":\"에스겔\",\"단\":\"다니엘\",\"호\":\"호세아\",\"욜\":\"요엘\",\"암\":\"아모스\",\"옵\":\"오바댜\",\"욘\":\"요나\",\"미\":\"미가\",\"나\":\"나훔\",\"합\":\"하박국\",\"습\":\"스바냐\",\"학\":\"학개\",\"슥\":\"스가랴\",\"말\":\"말라기\",\"마\":\"마태복음\",\"막\":\"마가복음\",\"눅\":\"누가복음\",\"요\":\"요한복음\",\"행\":\"사도행전\",\"롬\":\"로마서\",\"고전\":\"고린도전서\",\"고후\":\"고린도후서\",\"갈\":\"갈라디아서\",\"엡\":\"에베소서\",\"빌\":\"빌립보서\",\"골\":\"골로새서\",\"살전\":\"데살로니가전서\",\"살후\":\"데살로니가후서\",\"딤전\":\"디모데전서\",\"딤후\":\"디모데후서\",\"딛\":\"디도서\",\"몬\":\"빌레몬서\",\"히\":\"히브리서\",\"약\":\"야고보서\",\"벧전\":\"베드로전서\",\"벧후\":\"베드로후서\",\"요일\":\"요한일서\",\"요이\":\"요한2서\",\"요삼\":\"요한3서\",\"유\":\"유다서\",\"계\":\"요한계시록\"},\"yo\":{\"Gẹn\":\"Genesisi\",\"Eks\":\"Eksodu\",\"Lef\":\"Lefitiku\",\"Num\":\"Numeri\",\"Deu\":\"Deuteronomi\",\"Joṣ\":\"Ìwé Joṣua\",\"A. Oni\":\"Onidajọ\",\"Rut\":\"Rutu\",\"I. Sam\":\"I. Samueli\",\"II. Sam\":\"II. Samueli\",\"I. A. Ọba\":\"I. Awọn Ọba\",\"II. A. Ọba\":\"II. Awọn Ọba\",\"I. Kro\":\"I. Kronika\",\"II. Kro\":\"II. Kronika\",\"Esr\":\"Esra\",\"Neh\":\"Nehemiah\",\"Est\":\"Esteri\",\"Job\":\"Jobu\",\"O. Daf\":\"Orin Dafidi\",\"Owe\":\"Ìwé Owe\",\"Oni\":\"Ìwé Oniwasu\",\"O. Sol\":\"Orin Solomoni\",\"Isa\":\"Isaiah\",\"Jer\":\"Jeremiah\",\"Ẹk. Jer\":\"Ẹkún Jeremiah\",\"Esek\":\"Esekieli\",\"Dan\":\"Danieli\",\"Hos\":\"Hosea\",\"Joel\":\"Joeli\",\"Amo\":\"Amosi\",\"Oba\":\"Obadiah\",\"Jon\":\"Jona\",\"Mik\":\"Mika\",\"Nah\":\"Nahumu\",\"Hab\":\"Habakkuku\",\"Sef\":\"Sefaniah\",\"Hag\":\"Haggai\",\"Sek\":\"Sekariah\",\"Mal\":\"Malaki\",\"Mat\":\"Matteu\",\"Mak\":\"Marku\",\"Luk\":\"Luku\",\"Joh\":\"Johannu\",\"Iṣe Apo\":\"Iṣe Awọn Aposteli\",\"Rom\":\"Awọn Ara Romu\",\"I. Kor\":\"I. Awọn Ara Korinti\",\"II. Kor\":\"II. Awọn Ara Korinti\",\"Gal\":\"Awọn Ara Galatia\",\"Efe\":\"Awọn Ara Efesu\",\"Filp\":\"Awọn Ara Filippi\",\"Kol\":\"Awọn Ara Kolosse\",\"I. Tes\":\"I. Awọn Ara Tessalonika\",\"II. Tes\":\"II. Awọn Ara Tessalonika\",\"I. Tim\":\"I. Timoteu\",\"II. Tim\":\"II. Timoteu\",\"Tit\":\"Titu\",\"File\":\"Filemoni\",\"Heb\":\"Awọn Heberu\",\"Jak\":\"Jakọbu\",\"I. Pet\":\"I. Peteru\",\"II. Pet\":\"II. Peteru\",\"I. Joh\":\"I. Johannu\",\"II. Joh\":\"II. Johannu\",\"III. Joh\":\"III. Johannu\",\"Jud\":\"Juda\",\"Ifi.\":\"Ifihàn Ti Johannu\"},\"zh\":{\"创世记\":\"创世记\",\"出埃及\":\"出埃及\",\"利未记\":\"利未记\",\"民数记\":\"民数记\",\"申命记\":\"申命记\",\"约书亚记\":\"约书亚记\",\"士师记\":\"士师记\",\"路得记\":\"路得记\",\"撒母耳记上\":\"撒母耳记上\",\"撒母耳记下\":\"撒母耳记下\",\"列王纪上\":\"列王纪上\",\"列王纪下\":\"列王纪下\",\"历代志上\":\"历代志上\",\"历代志下\":\"历代志下\",\"以斯拉记\":\"以斯拉记\",\"尼希米记\":\"尼希米记\",\"以斯帖记\":\"以斯帖记\",\"约伯记\":\"约伯记\",\"诗篇\":\"诗篇\",\"箴言\":\"箴言\",\"传道书\":\"传道书\",\"雅歌\":\"雅歌\",\"以赛亚书\":\"以赛亚书\",\"耶利米书\":\"耶利米书\",\"耶利米哀歌\":\"耶利米哀歌\",\"以西结书\":\"以西结书\",\"但以理书\":\"但以理书\",\"何西阿书\":\"何西阿书\",\"约珥书\":\"约珥书\",\"阿摩司书\":\"阿摩司书\",\"俄巴底亚书\":\"俄巴底亚书\",\"约拿书\":\"约拿书\",\"弥迦书\":\"弥迦书\",\"那鸿书\":\"那鸿书\",\"哈巴谷书\":\"哈巴谷书\",\"西番雅书\":\"西番雅书\",\"哈该书\":\"哈该书\",\"撒迦利亚书\":\"撒迦利亚书\",\"玛拉基书\":\"玛拉基书\",\"马太福音\":\"马太福音\",\"马可福音\":\"马可福音\",\"路加福音\":\"路加福音\",\"约翰福音\":\"约翰福音\",\"使徒行传\":\"使徒行传\",\"罗马书\":\"罗马书\",\"哥林多前书\":\"哥林多前书\",\"哥林多后书\":\"哥林多后书\",\"加拉太书\":\"加拉太书\",\"以弗所书\":\"以弗所书\",\"腓立比书\":\"腓立比书\",\"歌罗西书\":\"歌罗西书\",\"帖撒罗尼迦前书\":\"帖撒罗尼迦前书\",\"帖撒罗尼迦后书\":\"帖撒罗尼迦后书\",\"提摩太前书\":\"提摩太前书\",\"提摩太后书\":\"提摩太后书\",\"提多书\":\"提多书\",\"腓利门书\":\"腓利门书\",\"希伯来书\":\"希伯来书\",\"雅各书\":\"雅各书\",\"彼得前书\":\"彼得前书\",\"彼得后书\":\"彼得后书\",\"约翰一书\":\"约翰一书\",\"约翰二书\":\"约翰二书\",\"约翰三书\":\"约翰三书\",\"犹大书\":\"犹大书\",\"启示录\":\"启示录\"}}";

BIBLEBOOKS = $.parseJSON(BIBLEBOOKS);

Object.keys = function(object) {
  var keys = [];
  for(var property in object) {
    keys.push(property);
  }
  return keys;
};

Object.values = function(object) {
  var arr = [];
  for(var property in object) {
    arr.push(object[property]);
  }
  return arr;
};

/******************************************************************************
 * Verse Search
 *
 * Note: use this function in preference to 'flexversesearch' as this function
 *       does not co-mingle the displaying of the results. In retrospect there
 *       should be chainable functions so that we can do something like:
 *           .mv_search().display_verses()
 *       but the callback will suffice for now.
 ******************************************************************************/
function mv_search(userText, displayResultsFn) {

    // This function definition is necessary to avoid repetition in the different types of
    // search queries. It handles the custom callback function for mv_search
    function searchResultsCallback( verses ) {
        if( $.isFunction(displayResultsFn) ) {
          displayResultsFn.call(this, verses);
        }
    };

    // Truncate queries of excessive length
    if (userText.length > 100) {
    	var text = jQuery.trim(userText).substring(0, 100).split(" ").slice(0, -1).join(" ");
    }
    else {
    	var text = userText;
    }

    // User is looking for a single verse
    if (ref = parseVerseRef( text )) {
        $.get("/lookup_user_verse.json", { bk: ref.bk, ch: ref.ch, vs: ref.vs },
            searchResultsCallback, "json" );

    // User is searching for a passage
    } else if (ref = parsePassageRef( text )) {
        $.get("/lookup_user_passage.json", { bk: ref.bk, ch: ref.ch, vs_start: ref.vs_start, vs_end: ref.vs_end },
            searchResultsCallback, "json" );

    // User didn't enter a verse reference ... do a tag search
    } else {
        $.get("/mv_tag_search.json", { searchParams: text },
            searchResultsCallback, "json" );
    };
}

/******************************************************************************
 * Return verse in all major translations
 ******************************************************************************/
function multiTranslationSearch(userText, displayResultsFn) {

    // This function definition is necessary to avoid repetition in the different types of
    // search queries. It handles the custom callback function for mv_search
    function searchResultsCallback( verses ) {
        if( $.isFunction(displayResultsFn) ) {
          displayResultsFn.call(this, verses);
        }
    };

    // Truncate queries of excessive length
    if (userText.length > 100) {
        var text = jQuery.trim(userText).substring(0, 100).split(" ").slice(0, -1).join(" ");
    }
    else {
        var text = userText;
    }

    // User is looking for a single verse
    if (ref = parseVerseRef( text )) {
        $.get("/major_tl_lookup.json", { bk: ref.bk, ch: ref.ch, vs: ref.vs },
            searchResultsCallback, "json" );
    };

}


/******************************************************************************
 * Search and display quiz questions associated with a verse reference
 ******************************************************************************/
function relatedQuestionsSearch(verseRef, displayResultsFn) {

    function searchResultsCallback( quiz_questions ) {
        if( $.isFunction(displayResultsFn) ) {
          displayResultsFn.call(this, quiz_questions);
        }
    };

    $.getJSON('/quiz_questions/search', { supporting_ref: verseRef }, searchResultsCallback, "json" );

}

/******************************************************************************
 * Capitalize strings: romans -> Romans
 ******************************************************************************/
String.prototype.capitalize = function() {
	if (this.charAt(0).match(/[1-3]/)) {
      return this.charAt(0) + this.charAt(1) + this.charAt(2).toUpperCase() + this.slice(3);
	} else {
      return this.charAt(0).toUpperCase() + this.slice(1);
	}
};

/******************************************************************************
 * Substitute abbreviations
 * Returns English book name
 ******************************************************************************/
function unabbreviate(book_name) {

	if(!(book_name.split(" ")[0].match('[^Ii]'))) { // Check if first "word" contains only I's; then Roman numerals to Arabic numbers
		book_name = book_name.replace(/III /i, "3 ").replace(/II /i, "2 ").replace(/I /i, "1 "); // replace first occurences
	}

	$.each( BIBLEBOOKS, function( lang, books ) {
		book_index = $.inArray ( book_name, Object.keys(books) );

		// break if match found
		if (book_index !== -1) return false;
	});

	if (book_index === -1) { // not a standard abbreviation
		// since it might be a nonstandard abbreviation, let's see if we can find only one possible match with book names
		possibilities = [];

		$.each( BIBLEBOOKS, function( lang, books ) {
			i = 0;
			$.each( BIBLEBOOKS[lang], function( abbrev, book ) {
				if (book.substring(0, book_name.length).toLowerCase() == book_name.toLowerCase())
				{
					possibilities.push(i);
				}
				i++;
			});

            // break if one English match found; otherwise there might be other Spanish matches
            if(possibilities.length == 1 && lang == "en") return false;
		});

		if (possibilities.length == 1) { // nonstandard abbreviation, one possibility
			return Object.values(BIBLEBOOKS['en'])[possibilities[0]];
		} else { // already unabbreviated book name (though it may be incorrect)
			return book_name;
		}
	} else { // was a standard abbreviation; return the unabbreviated book name
		return Object.values(BIBLEBOOKS['en'])[book_index];
	}
}

/******************************************************************************
 * Returns true if input is a valid _single_ verse reference
 * Accepts: Romans 8:1
 * Accepts: Romans 8: 1
 * Rejects: Romans 8
 * Rejects: Romans 8:1-3
 ******************************************************************************/
function validVerseRef(verseref) {
    return /([0-3]?\s+)?[a-záéíóúüñäõÄÕö\uAC00-\uD7A3]+\s+[0-9]+(:(\s)?|(\s?vs\s?))[0-9]+$/i.test(verseref);
}

/******************************************************************************
 * Returns true if input is a valid passage reference

 * Accepts: Romans 8
 * Accepts: Romans 8:
 * Accepts: Romans 8:1-3
 * Accepts: Romans 8: 1-3
 * Rejects: Romans 8:1
 *******************************************************************************/
function validPassageRef(passage) {
    return /([0-3]?\s+)?[a-záéíóúüñäõÄÕö\uAC00-\uD7A3]+\s+[0-9]+(((:(\s)?|(\s?vs\s?))[0-9]+(-)[0-9]+)|:)?$/i.test(passage);
}

/******************************************************************************
 * Returns true iff input is a chapter reference

 * Accepts: Romans 8
 * Accepts: Romans 8:
 * Rejects: Romans 8:1
 * Rejects: Romans 8:1-3
 *******************************************************************************/
function validChapterRef(passage) {
    return /([0-3]?\s+)?[a-záéíóúüñäõÄÕö\uAC00-\uD7A3]+\s+[0-9]+(:)?$/i.test(passage);
}

/******************************************************************************
 * Returns true iff input is a passage reference

 * Accepts: Romans 8:1-3
 * Rejects: Romans 8
 * Rejects: Romans 8:1
 *******************************************************************************/
function validSubChapterPassage(passage) {
    return /([0-3]?\s+)?[a-záéíóúüñäõÄÕö\uAC00-\uD7A3]+\s+[0-9]+(:|(\s?vs\s?))[0-9]+(-)[0-9]+/i.test(passage);
}

/******************************************************************************
 * Clean up user entered verses
 ******************************************************************************/
function cleanseVerseText( versetext ) {

	versetext = versetext.replace(/—/g, ' — ')    // add spaces around em dash
	                     .replace(/--/g, ' — ')   // replace double dash with em dash
	                     .replace(/\[\w\]/g, " ") // remove footnotes
	                     .replace(/\n/g,' ')      // remove newlines
	                     .replace(/\s{2,}/g,' '); // remove double space
	versetext = $.trim(versetext);                // remove trailing and leading whitespace. Using jQuery's trim() to support IE.

	return versetext;
}

/******************************************************************************
 * Remove special characters to compare user input to correct text
 * We remove anything that is not in the set of...
 	* alphanumerical characters
 	* specified sets of UTF-8 characters
 * This includes spaces
 * Then we also remove Greek diacritics
 ******************************************************************************/
scrub_text = function(text) {
    return text.toLowerCase().replace(/[^0-9a-z\u00BF-\u1FFF\u2C00-\uD7FF]+/g, "").
    replace(/[，一。！？：；（）]+/g, "").
    replace(/[´`͂῾᾿·]+/g, "").
    replace(/ό/g, "ο").
    replace(/ά/g, "α").
    replace(/ἐ/g, "ε").
    replace(/[ῖἱ]/g,"ι");
};

/******************************************************************************
 * Return width of word for blankify (hackish - would like a better way)
 * TODO: Should accept array of words and perform operations in bulk
 ******************************************************************************/
word_width = function(word) {

    if($("#word_width").length == 0) {

        // style the span
        styling = {
            "font-size":"larger",   // note: based on current CSS settings for font-size
            "position":"absolute",
            "visibility":"hidden",
            "height":"auto",
            "width":"auto"
        };

        span = $("<span/>").attr("id","word_width").css(styling);

        // make the span
        $("body").append(span);
    }

    // add the word
    $("#word_width").text(word);

    return $("#word_width").width();

};

/******************************************************************************
 * Blankify a verse
 ******************************************************************************/
function blankifyVerse(versetext, reduction_percentage, customWordWidth) {

    var split_text, sort_by_length, text_with_blanks;
    var getWordWidth = customWordWidth || word_width;

    if  ( reduction_percentage == 0 ) {

    	return versetext;

    }

    else {

	    split_text     = splitByWords(versetext);
	    split_text.forEach(function (e, i){
	    	split_text[i] = e.trim();
	    });
	    sort_by_length = split_text.slice(0);  // make a copy of the original array

	    sort_by_length.sort(function(a, b) {
	        return b.length - a.length;
	    });

	    // select the longest words to remove
	    sort_by_length.length = Math.round(split_text.length * reduction_percentage / 100);

	    text_with_blanks = split_text.map( function(x) {
	        if ( sort_by_length.indexOf(x) < 0 ) {
	            return "<span>" + x + " " + "</span>";
	        }
	        else {
                return "<input name='" + x + "' class='blank-word' style='width:" + getWordWidth(x) + "px' autocomplete='off'>";
            };
	    });

	    return text_with_blanks.join(" ");
    }

};

/******************************************************************************
 * Parses reference into a book, chapter & verse
 * Always uses English book name
 ******************************************************************************/
function parseVerseRef(verseref) {

	var split_text;
	var ch, bk, bi, vs;

	if (validVerseRef(verseref)) {

		// Handle corner cases
		verseref = verseref.replace(/(song of songs)/i, "Song Of Songs")
						   .replace(/(psalm )/i,        "Psalms ");

		split_text = verseref.split(/:\s|:|\s/);

		vs = parseInt(split_text.pop());
		ch = parseInt(split_text.pop());
		bk = unabbreviate( split_text.join(' ') );

        $.each( BIBLEBOOKS, function( lang, books ) {
            bi = $.inArray ( bk, Object.values(books) );
            lang_ = lang;

            // break if match found
            if (bi !== -1) return false;
        });

		if (bi === -1) {
			return false;
		}

        if (lang_ != "en")
        {
            bk = Object.values(BIBLEBOOKS.en)[bi];
        }

		return { bk: bk, ch: ch, vs: vs, bi: bi+1};
	} else {
		return false;
	};
}


/******************************************************************************
 * Check whether next review date has passed
 * Note: mv.next_test is a string with format 'yyyy-mm-dd'
 ******************************************************************************/
function mvDue( mv ) {

    var today           = new Date();
    var reviewDateArray = mv.next_test.match(/(\d+)/g);
    var nextReviewDate  = new Date( reviewDateArray[0], reviewDateArray[1]-1, reviewDateArray[2]); // Jan = 0

    return nextReviewDate < today
}

/******************************************************************************
 * Parses passage reference into a book, chapter, start verse & end verse
 * Always uses English book name
 ******************************************************************************/
function parsePassageRef(passage) {

	var split_text;
	var ch, bk, bi;
	var vs_start = null;
	var vs_end   = null;

	if (validPassageRef(passage)) {

		// Handle corner cases
		passage = passage.replace(/(song of songs)/i, "Song Of Songs")
						 .replace(/(psalm )/i,        "Psalms ")
                         .replace(/\:\s/, ':') // change colon + space to just a colon
						 .replace(/\:$/, '');  // Something like "Romans 8:" -- can happen on Add Verse page as user types

		split_text = passage.split(/:|-|\s/);  /* split on dash, colon or space */

		if (validSubChapterPassage(passage)) {
			vs_end   = parseInt(split_text.pop());
			vs_start = parseInt(split_text.pop());
		}

		ch       = parseInt(split_text.pop());
		bk       = unabbreviate( split_text.join(' ') );
		
		$.each( BIBLEBOOKS, function( lang, books ) {
			bi = $.inArray ( bk, Object.values(books) );
			lang_ = lang;

			// break if match found
			if (bi !== -1) return false;
		});

		if (bi === -1)
		{
			return false;
		}

		if (lang_ != "en") {
			bk = Object.values(BIBLEBOOKS.en)[bi];
		}

		return { bk: bk, ch: ch, vs_start: vs_start, vs_end: vs_end, bi: bi+1};

	} else {
		return false;
	};
}

/******************************************************************************
 * Scroll functionality
 ******************************************************************************/
function mvScrollNext() {
    if ($(".scrollable .pop-verse-group:visible").next().length != 0)
        $(".scrollable .pop-verse-group:visible").fadeOut(function(){
            $(this).next().fadeIn();
        });
    else {
        $(".scrollable .pop-verse-group:visible").fadeOut(function(){
            $(".scrollable .pop-verse-group:first").fadeIn();
        });
    }
    return false;
}

function mvScrollPrev() {
    if ($(".scrollable .pop-verse-group:visible").prev().length != 0)
        $(".scrollable .pop-verse-group:visible").fadeOut(function(){
            $(this).prev().fadeIn();
        });
    else {
        $(".scrollable .pop-verse-group:visible").fadeOut(function(){
            $(".scrollable .pop-verse-group:last").fadeIn();
        });
    }
    return false;
}

/******************************************************************************
 * Check for completed badges
 ******************************************************************************/
function mvCheckBadgeCompletion() {

    // First check whether any quests related to badges have been completed
	$.getJSON('/badge_quests_check.json', function(quests) {

		// There were instances of the quest for a given badge being completed but the
		// badge itself is not awarded. We removed the check for any completed
		// quests below and now always check for completed badges at the end of every session.
        // We used to check if ( quests.length !== 0 )

		// Check for awarded badges
		$.getJSON('/badge_completion_check.json', function(badges) {
			// Alert user to completed badges
			if ( badges.length !== 0 ) {
				for (var i = 0; i < badges.length; i++) {
					displayAlertMessage("Congratulations! You have been awarded a " + badges[i]["color"] + " " + badges[i]["name"] + " badge.");
				}
			}
		});

	});
}

/******************************************************************************
 * Show an alert
 ******************************************************************************/
function displayAlertMessage(message) {

	var timeOut = 7;

	$('.mvMessageBox').text(message).fadeIn().css('display', 'block');
	setTimeout(function() {
		jQuery('.mvMessageBox').fadeOut().css('display', 'none');
	}, timeOut * 1000);
}

/******************************************************************************
 * All DOM attachments that are common to multiple pages should go here
 ******************************************************************************/
// $(document).ready( function() {
// 	$('input#verse').focus().autocomplete({ source: Object.values(BIBLEBOOKS.en) });
// });

// $(document).ajaxStart( function () {
//     $('.spinner').show();
// });

// $(document).ajaxStop( function () {
//     $('.spinner').hide();
// });
